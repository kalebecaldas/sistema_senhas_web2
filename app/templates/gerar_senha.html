{% extends "base.html" %}
{% block title %}Retirar Senha{% endblock %}

{% block content %}
<style>
  html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background-color: #f9f9f9;
    text-align: center;
    font-family: Arial, sans-serif;
  }

  main { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; padding: 1rem; gap: 2rem; }
  .step { display: none; flex-direction: column; align-items: center; gap: 2rem; animation: fadeIn 0.5s ease-in-out; }
  .step.active { display: flex; }
  .retira-btn { font-size: 2rem; padding: 1.3rem 2.5rem; border-radius: 12px; min-width: 260px; transition: filter 0.3s ease; }
  .retira-btn:hover { filter: brightness(1.1); }
  .popup { display: none; flex-direction: column; align-items: center; justify-content: center; height: 70vh; font-size: 2rem; color: #198754; animation: fadeIn 0.5s ease-in-out; }
  .senha-grande { font-size: 5.5rem; margin-top: 1rem; font-weight: bold; }
  .progress-bar { width: 80%; height: 10px; background-color: #ccc; margin-top: 2rem; border-radius: 5px; overflow: hidden; }
  .progress-bar-fill { width: 0%; height: 100%; background-color: #198754; animation: fillBar 5s linear forwards; }
  .back-btn { border: none; background: none; font-size: 1.5rem; cursor: pointer; color: gray; position: absolute; top: 1rem; left: 1rem; transition: color 0.3s; }
  .back-btn:hover { color: black; }
  #fullscreen-init { position: fixed; inset: 0; background: black; color: white; display: flex; align-items: center; justify-content: center; flex-direction: column; z-index: 3000; }
  #fullscreen-init button { font-size: 2rem; padding: 1.2rem 2.5rem; }
  @keyframes fillBar { from { width: 0%; } to { width: 100%; } }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  #connection-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; flex-direction: column; z-index: 2000; color: white; font-size: 1.5rem; }
  .connection-bar { width: 60%; height: 10px; background: #444; border-radius: 5px; overflow: hidden; margin-top: 1rem; }
  .connection-bar-fill { width: 0%; height: 100%; background: #0f0; animation: loopBar 2s linear infinite; }
  @keyframes loopBar { 0% { width: 0%; } 50% { width: 100%; } 100% { width: 0%; } }
</style>

<div id="fullscreen-init">
  <button onclick="iniciarFullscreen()" class="btn btn-success">Iniciar Retirada de Senha</button>
  <p style="margin-top: 1rem;">Toque para continuar em tela cheia</p>
</div>

<main>
  <div id="step1" class="step active">
    <h2>Voc√™ √© um paciente:</h2>
    <button onclick="selecionarTipo('normal')" class="btn btn-primary retira-btn">Normal</button>
    <button onclick="selecionarTipo('preferencial')" class="btn btn-warning retira-btn">Preferencial</button>
  </div>

  <div id="step2" class="step">
    <button class="back-btn" onclick="voltarPasso1()">‚Üê Voltar</button>
    <h2>√â sua primeira vez?</h2>
    <button onclick="selecionarPrimeiraVez(true)" class="btn btn-success retira-btn">Sim, primeira vez</button>
    <button onclick="selecionarPrimeiraVez(false)" class="btn btn-secondary retira-btn">N√£o, j√° sou paciente</button>
  </div>

  <div id="popup" class="popup">
    <div>Sua senha est√° sendo impressa...</div>
    <div class="senha-grande" id="senha-numero">Senha --</div>
    <div class="progress-bar"><div class="progress-bar-fill"></div></div>
  </div>
</main>

<div id="connection-overlay">
  <div>Conex√£o perdida. Reconectando...</div>
  <div class="connection-bar"><div class="connection-bar-fill"></div></div>
</div>

<script>
  let tipoSelecionado = null;
  let pingInterval = null;

  function iniciarFullscreen() {
    const el = document.documentElement;
    if (el.requestFullscreen) el.requestFullscreen();
    else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
    else if (el.msRequestFullscreen) el.msRequestFullscreen();

    // ü™Ñ Solicita orienta√ß√£o horizontal (landscape)
    if (screen.orientation && screen.orientation.lock) {
      screen.orientation.lock('landscape').then(() => {
        console.log("‚úÖ Tela bloqueada em paisagem.");
      }).catch(err => {
        console.warn("‚ùå N√£o foi poss√≠vel bloquear orienta√ß√£o:", err);
      });
    }

    document.getElementById('fullscreen-init').style.display = 'none';
  }

  function selecionarTipo(tipo) {
    tipoSelecionado = tipo;
    document.getElementById('step1').classList.remove('active');
    document.getElementById('step2').classList.add('active');
  }

  function voltarPasso1() {
    tipoSelecionado = null;
    document.getElementById('step2').classList.remove('active');
    document.getElementById('step1').classList.add('active');
  }

  async function testarConexao() {
    try {
      const res = await fetch('/ping');
      if (res.ok) {
        clearInterval(pingInterval);
        document.getElementById('connection-overlay').style.display = 'none';
        document.getElementById('step2').classList.add('active');
        console.log("‚úÖ Reconectado com sucesso.");
      }
    } catch {
      console.warn("‚ùå Tentativa de reconex√£o falhou.");
    }
  }

  async function selecionarPrimeiraVez(primeiraVez) {
    try {
      const resp = await fetch(`/api/gerar_senha?tipo=${tipoSelecionado}&primeira=${primeiraVez}`);
      if (!resp.ok) throw new Error();
      const dados = await resp.json();

      document.getElementById('step2').classList.remove('active');
      document.getElementById('popup').classList.add('active');
      document.getElementById('senha-numero').textContent =
        'Senha ' + dados.sigla + String(dados.numero).padStart(4, '0');

      const bar = document.querySelector('.progress-bar-fill');
      bar.style.animation = 'none'; void bar.offsetWidth; bar.style.animation = null;

      setTimeout(() => {
        document.getElementById('popup').classList.remove('active');
        document.getElementById('step1').classList.add('active');
        tipoSelecionado = null;
      }, 5000);
    } catch (e) {
      document.getElementById('step2').classList.remove('active');
      document.getElementById('connection-overlay').style.display = 'flex';
      pingInterval = setInterval(testarConexao, 2000);
      console.warn("‚ö†Ô∏è Erro ao gerar senha. Iniciando tentativa de reconex√£o...");
    }
  }

  // Ping inicial para manter sess√£o
  (() => {
    fetch('/ping')
      .then(r => {
        if (!r.ok) console.warn("‚ö†Ô∏è Ping falhou.");
      })
      .catch(() => console.warn("‚ùå Ping n√£o p√¥de ser enviado."));
  })();

  window.addEventListener('offline', () => console.warn("üì¥ Dispositivo offline."));
  window.addEventListener('online', () => console.log("üì∂ Dispositivo online."));
</script>

<script>
  console.log("üß≠ Endpoint atual:", "{{ g.endpoint }}");
</script>
{% endblock %}
